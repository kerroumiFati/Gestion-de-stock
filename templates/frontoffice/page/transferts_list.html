{% load i18n %}
{% load static %}

<div class="container-fluid">
    <div class="card bg-white">
        <div class="card-header card-color">
            <p class="h4 text-center text-uppercase font-weight-bold pt-2">
                <i class="fa fa-exchange-alt"></i> {% trans "Historique des Transferts" %}
            </p>
        </div>
        <div class="card-body">
            <!-- Filtres -->
            <div class="card mb-3">
                <div class="card-body">
                    <form method="get" class="row">
                        <div class="col-md-3">
                            <label for="statut"><i class="fa fa-filter"></i> {% trans "Statut" %}:</label>
                            <select name="statut" id="statut" class="form-control" onchange="this.form.submit()">
                                <option value="">{% trans "Tous" %}</option>
                                <option value="brouillon" {% if statut_filter == "brouillon" %}selected{% endif %}>{% trans "Brouillon" %}</option>
                                <option value="valide" {% if statut_filter == "valide" %}selected{% endif %}>{% trans "Validé" %}</option>
                                <option value="annule" {% if statut_filter == "annule" %}selected{% endif %}>{% trans "Annulé" %}</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="source"><i class="fa fa-warehouse"></i> {% trans "Source" %}:</label>
                            <select name="source" id="source" class="form-control" onchange="this.form.submit()">
                                <option value="">{% trans "Tous" %}</option>
                                {% for e in entrepots %}
                                <option value="{{ e.id }}" {% if source_filter == e.id|stringformat:"s" %}selected{% endif %}>
                                    {{ e.code }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="destination"><i class="fa fa-truck"></i> {% trans "Destination" %}:</label>
                            <select name="destination" id="destination" class="form-control" onchange="this.form.submit()">
                                <option value="">{% trans "Tous" %}</option>
                                {% for e in entrepots %}
                                <option value="{{ e.id }}" {% if dest_filter == e.id|stringformat:"s" %}selected{% endif %}>
                                    {{ e.code }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <a href="#" onclick="show('charger_van'); return false;" class="btn btn-primary btn-block">
                                <i class="fa fa-plus"></i> {% trans "Nouveau chargement" %}
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tableau -->
            <div class="table-responsive">
                <table class="table table-striped table-hover" data-no-datatable="true">
                    <thead class="thead-dark">
                        <tr>
                            <th width="30"></th>
                            <th>{% trans "Numéro" %}</th>
                            <th>{% trans "Date" %}</th>
                            <th>{% trans "Source" %}</th>
                            <th>{% trans "Destination" %}</th>
                            <th class="text-center">{% trans "Nb Lignes" %}</th>
                            <th class="text-center">{% trans "Nb Produits" %}</th>
                            <th>{% trans "Demandeur" %}</th>
                            <th>{% trans "Statut" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for transfert in transferts %}
                        <tr class="transfert-row" style="cursor: pointer;" onclick="toggleDetails({{ transfert.id }})">
                            <td class="text-center">
                                <i class="fa fa-chevron-right" id="icon-{{ transfert.id }}"></i>
                            </td>
                            <td><strong>{{ transfert.numero }}</strong></td>
                            <td>{{ transfert.date_creation|date:"d/m/Y H:i" }}</td>
                            <td>
                                <i class="fa fa-warehouse"></i> {{ transfert.entrepot_source.code }}
                            </td>
                            <td>
                                {% if transfert.entrepot_destination.code|slice:":3" == "VAN" %}
                                <i class="fa fa-truck"></i>
                                {% else %}
                                <i class="fa fa-warehouse"></i>
                                {% endif %}
                                {{ transfert.entrepot_destination.code }}
                            </td>
                            <td class="text-center">{{ transfert.get_nombre_lignes }}</td>
                            <td class="text-center">{{ transfert.get_nombre_produits }}</td>
                            <td>
                                {% if transfert.demandeur %}
                                <i class="fa fa-user"></i> {{ transfert.demandeur.username }}
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>
                                {% if transfert.statut == "brouillon" %}
                                <span class="badge badge-secondary">{% trans "Brouillon" %}</span>
                                {% elif transfert.statut == "valide" %}
                                <span class="badge badge-success">{% trans "Validé" %}</span>
                                {% elif transfert.statut == "en_transit" %}
                                <span class="badge badge-info">{% trans "En transit" %}</span>
                                {% elif transfert.statut == "receptionne" %}
                                <span class="badge badge-primary">{% trans "Réceptionné" %}</span>
                                {% elif transfert.statut == "annule" %}
                                <span class="badge badge-danger">{% trans "Annulé" %}</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr id="details-{{ transfert.id }}" style="display: none; background-color: #f8f9fa;">
                            <td colspan="9">
                                <div class="p-3">
                                    <h6><i class="fa fa-box"></i> {% trans "Produits transférés" %}:</h6>
                                    <table class="table table-sm table-bordered" data-no-datatable="true">
                                        <thead>
                                            <tr>
                                                <th>{% trans "Référence" %}</th>
                                                <th>{% trans "Désignation" %}</th>
                                                <th class="text-center">{% trans "Quantité envoyée" %}</th>
                                                {% if transfert.statut == "receptionne" %}
                                                <th class="text-center">{% trans "Quantité reçue" %}</th>
                                                {% endif %}
                                                <th>{% trans "Notes" %}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for ligne in transfert.lignes.all %}
                                            <tr>
                                                <td><strong>{{ ligne.produit.reference }}</strong></td>
                                                <td>{{ ligne.produit.designation }}</td>
                                                <td class="text-center">
                                                    <span class="badge badge-info">{{ ligne.quantite }} {{ ligne.produit.get_unite_mesure_display }}</span>
                                                </td>
                                                {% if transfert.statut == "receptionne" %}
                                                <td class="text-center">
                                                    {% if ligne.quantite_recue %}
                                                    <span class="badge {% if ligne.quantite_recue == ligne.quantite %}badge-success{% else %}badge-warning{% endif %}">
                                                        {{ ligne.quantite_recue }} {{ ligne.produit.get_unite_mesure_display }}
                                                    </span>
                                                    {% else %}
                                                    -
                                                    {% endif %}
                                                </td>
                                                {% endif %}
                                                <td>{{ ligne.notes|default:"-" }}</td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="{% if transfert.statut == 'receptionne' %}5{% else %}4{% endif %}" class="text-center text-muted">{% trans "Aucun produit" %}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    {% if transfert.notes %}
                                    <div class="alert alert-info mt-2">
                                        <strong><i class="fa fa-comment"></i> {% trans "Notes" %}:</strong> {{ transfert.notes }}
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="text-center text-muted py-4">
                                <i class="fa fa-inbox fa-3x d-block mb-3"></i>
                                {% trans "Aucun transfert trouvé" %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {% if transferts.has_other_pages %}
            <nav aria-label="Pagination">
                <ul class="pagination justify-content-center">
                    {% if transferts.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="event.preventDefault(); loadTransfertsPage({{ transferts.previous_page_number }})">
                            {% trans "Précédent" %}
                        </a>
                    </li>
                    {% endif %}

                    <li class="page-item active">
                        <span class="page-link">
                            Page {{ transferts.number }} sur {{ transferts.paginator.num_pages }}
                        </span>
                    </li>

                    {% if transferts.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="event.preventDefault(); loadTransfertsPage({{ transferts.next_page_number }})">
                            {% trans "Suivant" %}
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Fonction pour afficher/masquer les détails d'un transfert
function toggleDetails(transfertId) {
    const detailsRow = document.getElementById('details-' + transfertId);
    const icon = document.getElementById('icon-' + transfertId);

    if (detailsRow.style.display === 'none') {
        detailsRow.style.display = 'table-row';
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-down');
    } else {
        detailsRow.style.display = 'none';
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-right');
    }
}

// Fonction pour gérer la pagination et les filtres
function loadTransfertsPage(page) {
    const statut = document.getElementById('statut')?.value || '';
    const source = document.getElementById('source')?.value || '';
    const destination = document.getElementById('destination')?.value || '';

    let url = '/page/transferts_list/?page=' + page;
    if (statut) url += '&statut=' + statut;
    if (source) url += '&source=' + source;
    if (destination) url += '&destination=' + destination;

    // Recharger le contenu via fetch
    fetch(url)
        .then(res => res.text())
        .then(html => {
            document.getElementById('main-content').innerHTML = html;
        })
        .catch(err => console.error('Erreur de chargement:', err));
}

// Gérer les changements de filtres
document.addEventListener('fragment:loaded', function(e) {
    if (e.detail.name === 'transferts_list') {
        // Les selects ont déjà onchange="this.form.submit()" - on les intercepte
        const selects = document.querySelectorAll('select[onchange]');
        selects.forEach(select => {
            select.removeAttribute('onchange');
            select.addEventListener('change', function() {
                loadTransfertsPage(1);
            });
        });
    }
});
</script>
