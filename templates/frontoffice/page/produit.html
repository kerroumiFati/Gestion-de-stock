{% load static %}
{% load i18n %}
<script src="{% static 'script/produit.js' %}" type="text/javascript"></script>

<style>
/* Design sobre et professionnel pour Gestion des produits */
.products-container {
    padding: 20px 0;
}

.products-title {
    font-size: 1.8rem;
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e2e8f0;
    display: flex;
    align-items: center;
    gap: 12px;
}

.products-title i {
    color: #4a5568;
}

.form-section {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    padding: 30px;
    margin-bottom: 25px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.form-section-header {
    font-size: 1.1rem;
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.form-section-header i {
    color: #4a5568;
}

.form-label-product {
    font-weight: 500;
    color: #4a5568;
    margin-bottom: 6px;
    font-size: 0.9rem;
}

.form-control-product {
    border: 1px solid #cbd5e0;
    border-radius: 6px;
    padding: 10px 15px;
    transition: all 0.2s ease;
}

.form-control-product:focus {
    border-color: #4a5568;
    box-shadow: 0 0 0 3px rgba(74, 85, 104, 0.1);
    outline: none;
}

.btn-product {
    border-radius: 6px;
    padding: 10px 20px;
    font-weight: 500;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-product-primary {
    background: #2d3748;
    color: white;
    border: none;
}

.btn-product-primary:hover {
    background: #1a202c;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(45, 55, 72, 0.2);
    color: white;
}

.btn-product-secondary {
    background: #e2e8f0;
    color: #2d3748;
    border: 1px solid #cbd5e0;
}

.btn-product-secondary:hover {
    background: #cbd5e0;
    color: #2d3748;
}

.table-section {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    padding: 25px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.table-product {
    margin-bottom: 0;
}

.table-product thead th {
    background: #f7fafc;
    border: none;
    padding: 15px 12px;
    font-weight: 600;
    color: #4a5568;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
}

.table-product tbody td {
    padding: 12px;
    border-bottom: 1px solid #e2e8f0;
    vertical-align: middle;
}

.table-product tbody tr:hover {
    background: #f7fafc;
}

.action-btn-product {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.85rem;
    border: none;
    transition: all 0.2s ease;
    cursor: pointer;
}

.action-btn-product:hover {
    transform: scale(1.05);
}

.btn-edit {
    background: #4a5568;
    color: white;
}

.btn-edit:hover {
    background: #2d3748;
    color: white;
}

.btn-delete {
    background: #e2e8f0;
    color: #4a5568;
}

.btn-delete:hover {
    background: #cbd5e0;
    color: #2d3748;
}

.action-buttons-group {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e2e8f0;
}

.risk-management-box {
    background: #f7fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 15px;
}

/* État vide du tableau */
.table-product tbody:empty::after {
    content: 'Aucun produit enregistré';
    display: block;
    text-align: center;
    padding: 40px;
    color: #a0aec0;
    font-style: italic;
}

/* Amélioration des inputs number */
input[type="number"].form-control-product {
    -moz-appearance: textfield;
}

input[type="number"].form-control-product::-webkit-inner-spin-button,
input[type="number"].form-control-product::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

/* Badge pour le statut du stock */
.stock-badge {
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 500;
}

.stock-badge-ok {
    background: #f0f0f0;
    color: #4a5568;
}

.stock-badge-low {
    background: #fff3cd;
    color: #856404;
}

.stock-badge-critical {
    background: #f8d7da;
    color: #721c24;
}

/* Custom Select Dropdown avec scroll */
.custom-select-container {
    position: relative;
    width: 100%;
}

.custom-select-trigger {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 15px;
    border: 1px solid #cbd5e0;
    border-radius: 6px;
    background: white;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 42px;
}

.custom-select-trigger:hover {
    border-color: #4a5568;
}

.custom-select-trigger.open {
    border-color: #4a5568;
    box-shadow: 0 0 0 3px rgba(74, 85, 104, 0.1);
}

.custom-select-trigger .selected-text {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    color: #2d3748;
}

.custom-select-trigger .selected-text.placeholder {
    color: #a0aec0;
}

.custom-select-trigger .arrow {
    margin-left: 10px;
    transition: transform 0.2s;
    color: #4a5568;
}

.custom-select-trigger.open .arrow {
    transform: rotate(180deg);
}

.custom-select-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #cbd5e0;
    border-top: none;
    border-radius: 0 0 6px 6px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    display: none;
}

.custom-select-dropdown.open {
    display: block;
}

.custom-select-search {
    padding: 10px;
    border-bottom: 1px solid #e2e8f0;
}

.custom-select-search input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    font-size: 0.9rem;
}

.custom-select-search input:focus {
    outline: none;
    border-color: #4a5568;
}

.custom-select-options {
    max-height: 250px;
    overflow-y: auto;
}

/* Scrollbar personnalisée */
.custom-select-options::-webkit-scrollbar {
    width: 8px;
}

.custom-select-options::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.custom-select-options::-webkit-scrollbar-thumb {
    background: #cbd5e0;
    border-radius: 4px;
}

.custom-select-options::-webkit-scrollbar-thumb:hover {
    background: #a0aec0;
}

.custom-select-option {
    padding: 10px 15px;
    cursor: pointer;
    transition: background 0.15s;
    border-bottom: 1px solid #f7fafc;
}

.custom-select-option:hover {
    background: #f7fafc;
}

.custom-select-option.selected {
    background: #edf2f7;
    font-weight: 500;
}

.custom-select-option .option-ref {
    font-weight: 600;
    color: #2d3748;
}

.custom-select-option .option-name {
    color: #718096;
    font-size: 0.85rem;
    margin-left: 8px;
}

.custom-select-no-results {
    padding: 15px;
    text-align: center;
    color: #a0aec0;
    font-style: italic;
}

/* Cacher les selects natifs remplacés */
#prix_prod_produit,
#prix_prod_filter,
#prix_prod_code,
#prix_prod_type {
    display: none !important;
    visibility: hidden !important;
    position: absolute !important;
    width: 0 !important;
    height: 0 !important;
    overflow: hidden !important;
}
</style>

<div class="container-fluid">
    <!-- Modal d'erreur -->
    <div class="modal fade" id="error" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content" style="border-radius: 10px; border: none;">
                <div class="modal-header" style="background: #f7fafc; border-bottom: 1px solid #e2e8f0;">
                    <h5 class="modal-title" id="exampleModalLabel" style="color: #2d3748; font-weight: 600;">
                        <i class="fas fa-exclamation-triangle"></i> {% trans "Erreur" %}
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="padding: 20px;">
                    <p style="margin: 0; color: #4a5568;">
                        <i class="fas fa-info-circle"></i>
                        {% trans "Le produit a été marqué comme inactif car il est référencé dans des transactions (achats, ventes, mouvements)." %}
                    </p>
                    <p style="margin: 10px 0 0 0; color: #718096; font-size: 0.9rem;">
                        {% trans "Il n'apparaîtra plus dans la liste des produits actifs." %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="products-container">
        <h1 class="products-title">
            <i class="fas fa-boxes"></i> {% trans "Gestion des Produits" %}
        </h1>

        <!-- SECTION 1 : Formulaire de produit -->
        <div class="form-section">
            <h5 class="form-section-header">
                <i class="fas fa-edit"></i> {% trans "Ajouter / Modifier un Produit" %}
            </h5>

            <form id="product-form"> {% csrf_token %}
                <div id="product-alerts" class="mb-3"></div>
                <!-- Informations de base -->
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="reference" class="form-label-product">
                            <i class="fas fa-barcode"></i> {% trans "Référence" %}
                        </label>
                        <input type="text" id="id" hidden>
                        <input class="form-control form-control-product" type="text" id="reference" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="code_barre" class="form-label-product">
                            <i class="fas fa-qrcode"></i> {% trans "Code-barres" %}
                        </label>
                        <input class="form-control form-control-product" type="text" id="code_barre" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="designation" class="form-label-product">
                            <i class="fas fa-tag"></i> {% trans "Désignation" %}
                        </label>
                        <input class="form-control form-control-product" type="text" id="designation" required>
                    </div>
                </div>

                <!-- Catégorie et Prix -->
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="categorie" class="form-label-product">
                            <i class="fas fa-folder"></i> {% trans "Catégorie" %}
                        </label>
                        <select class="form-control form-control-product" id="categorie" required>
                            <option value="">{% trans "Sélectionner une catégorie" %}</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="prixU" class="form-label-product">
                            <i class="fas fa-dollar-sign"></i> {% trans "Prix Unitaire" %}
                        </label>
                        <input class="form-control form-control-product" type="number" id="prixU" step="0.01" min="0" placeholder="0.00">
                    </div>
                </div>

                <!-- Risk Management -->
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="risk" class="form-label-product">
                            <i class="fas fa-exclamation-triangle"></i> {% trans "Risk Management" %}
                        </label>
                        <input class="form-control form-control-product" type="number" id="risk">
                        <div class="d-flex gap-2 mt-2">
                            <button type="button" class="btn btn-product btn-product-secondary flex-fill" id="btnrisk">
                                <i class="fas fa-check"></i> {% trans "Check" %}
                            </button>
                            <button type="button" class="btn btn-product btn-product-secondary flex-fill" id="btnref">
                                <i class="fas fa-sync"></i> {% trans "Refresh" %}
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Bouton d'action -->
                <div class="action-buttons-group">
                    <button type="button" class="btn btn-product btn-product-primary" id="btn">
                        <i class="fas fa-plus"></i> {% trans "Ajouter le produit" %}
                    </button>
                </div>
            </form>
        </div>

        <!-- SECTION 2 : Onglets (Liste Produits / Types Prix / Prix Produits) -->
        <div class="form-section">
            <!-- Onglets -->
            <ul class="nav nav-tabs mb-3" id="productTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="liste-produits-tab" data-toggle="tab" href="#liste-produits" role="tab">
                        <i class="fa fa-list"></i> {% trans "Liste des Produits" %}
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="codes-prix-tab" data-toggle="tab" href="#codes-prix" role="tab">
                        <i class="fa fa-tags"></i> {% trans "Codes de Prix" %}
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="prix-produits-tab" data-toggle="tab" href="#prix-produits" role="tab">
                        <i class="fa fa-dollar-sign"></i> {% trans "Prix par Produit" %}
                    </a>
                </li>
            </ul>

            <div class="tab-content" id="productTabContent">
                <!-- Onglet 1 : Liste des Produits -->
                <div class="tab-pane fade show active" id="liste-produits" role="tabpanel">
                    <!-- Sélecteur de type de prix -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label-product">
                                <i class="fa fa-tag"></i> {% trans "Afficher les prix" %} :
                            </label>
                            <select id="display_price_type" class="form-control form-control-product">
                                <option value="">{% trans "Prix de base (prixU)" %}</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <div class="alert alert-info mb-0" style="padding: 10px;">
                                <i class="fa fa-info-circle"></i> <small>{% trans "Sélectionnez un type de prix pour afficher les prix correspondants dans le tableau ci-dessous" %}</small>
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table id="tproduit" class="table table-product table-hover">
                            <thead>
                                <tr>
                                    <th scope="col">{% trans "ID" %}</th>
                                    <th scope="col">{% trans "Référence" %}</th>
                                    <th scope="col">{% trans "Code-barres" %}</th>
                                    <th scope="col">{% trans "Désignation" %}</th>
                                    <th scope="col">{% trans "Catégorie" %}</th>
                                    <th scope="col">{% trans "Prix U" %}</th>
                                    <th scope="col" class="text-center">{% trans "Actions" %}</th>
                                </tr>
                            </thead>
                            <tbody id="table-content">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Onglet 2 : Codes de Prix -->
                <div class="tab-pane fade" id="codes-prix" role="tabpanel">
                    <div class="alert alert-info">
                        <i class="fa fa-info-circle"></i> <strong>{% trans "Codes de prix" %} :</strong> {% trans "Définissez les codes promotionnels ou périodiques (STANDARD, AID, RAMADAN, etc.)" %}
                    </div>

                    <!-- Formulaire d'ajout de code de prix -->
                    <div class="row mb-3">
                        <div class="col-md-2">
                            <label class="form-label-product">{% trans "Code" %} *</label>
                            <input type="text" id="code_prix_code" class="form-control form-control-product" placeholder="{% trans 'Ex: AID' %}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label-product">{% trans "Libellé" %} *</label>
                            <input type="text" id="code_prix_libelle" class="form-control form-control-product" placeholder="{% trans 'Ex: Prix Aïd' %}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label-product">{% trans "Date début" %}</label>
                            <input type="date" id="code_prix_date_debut" class="form-control form-control-product">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label-product">{% trans "Date fin" %}</label>
                            <input type="date" id="code_prix_date_fin" class="form-control form-control-product">
                        </div>
                        <div class="col-md-1">
                            <label class="form-label-product">{% trans "Ordre" %}</label>
                            <input type="number" id="code_prix_ordre" class="form-control form-control-product" min="0" value="0">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" id="btn_add_code_prix" class="btn btn-product-primary w-100">
                                <i class="fa fa-plus"></i> {% trans "Ajouter" %}
                            </button>
                        </div>
                    </div>

                    <!-- Tableau des codes de prix -->
                    <div class="table-responsive">
                        <table class="table table-product table-hover">
                            <thead>
                                <tr>
                                    <th>{% trans "Code" %}</th>
                                    <th>{% trans "Libellé" %}</th>
                                    <th>{% trans "Période" %}</th>
                                    <th>{% trans "Ordre" %}</th>
                                    <th>{% trans "Défaut" %}</th>
                                    <th>{% trans "Statut" %}</th>
                                    <th>{% trans "Nb Tournées" %}</th>
                                    <th>{% trans "Actions" %}</th>
                                </tr>
                            </thead>
                            <tbody id="codes_prix_body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Onglet Prix Produits -->
                <div class="tab-pane fade" id="prix-produits" role="tabpanel">
                    <div class="alert alert-info">
                        <i class="fa fa-info-circle"></i> <strong>{% trans "Prix multiples" %} :</strong> {% trans "Définissez plusieurs prix pour un même produit selon le type de client ou la quantité" %}
                    </div>

                    <!-- Formulaire d'ajout de prix produit -->
                    <div class="row mb-3">
                        <div class="col-md-2">
                            <label class="form-label-product">{% trans "Produit" %} *</label>
                            <!-- Custom Select pour Produit -->
                            <div class="custom-select-container" id="customSelectProduit">
                                <div class="custom-select-trigger" onclick="toggleCustomSelect('customSelectProduit')">
                                    <span class="selected-text placeholder">{% trans "Sélectionner un produit" %}</span>
                                    <i class="fas fa-chevron-down arrow"></i>
                                </div>
                                <div class="custom-select-dropdown">
                                    <div class="custom-select-search">
                                        <input type="text" placeholder="{% trans 'Rechercher...' %}" oninput="filterCustomSelectOptions('customSelectProduit', this.value)">
                                    </div>
                                    <div class="custom-select-options">
                                        <!-- Options seront ajoutées via JS -->
                                    </div>
                                </div>
                            </div>
                            <!-- Select caché pour compatibilité avec produit.js -->
                            <div style="position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);">
                                <select id="prix_prod_produit">
                                    <option value="">{% trans "Sélectionner un produit" %}</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label-product">{% trans "Code Prix" %}</label>
                            <!-- Custom Select pour Code Prix -->
                            <div class="custom-select-container" id="customSelectCodePrix">
                                <div class="custom-select-trigger" onclick="toggleCustomSelect('customSelectCodePrix')">
                                    <span class="selected-text placeholder">{% trans "Standard" %}</span>
                                    <i class="fas fa-chevron-down arrow"></i>
                                </div>
                                <div class="custom-select-dropdown">
                                    <div class="custom-select-search">
                                        <input type="text" placeholder="{% trans 'Rechercher...' %}" oninput="filterCustomSelectOptions('customSelectCodePrix', this.value)">
                                    </div>
                                    <div class="custom-select-options">
                                    </div>
                                </div>
                            </div>
                            <div style="position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);">
                                <select id="prix_prod_code">
                                    <option value="">{% trans "Standard" %}</option>
                                </select>
                            </div>
                            <small class="text-muted">{% trans "(optionnel)" %}</small>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label-product">{% trans "Type Prix" %} *</label>
                            <!-- Custom Select pour Type Prix -->
                            <div class="custom-select-container" id="customSelectTypePrix">
                                <div class="custom-select-trigger" onclick="toggleCustomSelect('customSelectTypePrix')">
                                    <span class="selected-text placeholder">{% trans "Sélectionner un type" %}</span>
                                    <i class="fas fa-chevron-down arrow"></i>
                                </div>
                                <div class="custom-select-dropdown">
                                    <div class="custom-select-search">
                                        <input type="text" placeholder="{% trans 'Rechercher...' %}" oninput="filterCustomSelectOptions('customSelectTypePrix', this.value)">
                                    </div>
                                    <div class="custom-select-options">
                                    </div>
                                </div>
                            </div>
                            <div style="position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);">
                                <select id="prix_prod_type">
                                    <option value="">{% trans "Sélectionner un type" %}</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label-product">{% trans "Prix" %} *</label>
                            <input type="number" id="prix_prod_prix" class="form-control form-control-product" min="0" step="0.01" placeholder="0.00">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label-product">{% trans "Qté Min" %}</label>
                            <input type="number" id="prix_prod_qte_min" class="form-control form-control-product" min="1" value="1">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" id="btn_add_prix_prod" class="btn btn-product-primary w-100">
                                <i class="fa fa-plus"></i> {% trans "Ajouter" %}
                            </button>
                        </div>
                    </div>

                    <!-- Dates de validité (pour promotions) -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label class="form-label-product">{% trans "Date début (optionnel)" %}</label>
                            <input type="date" id="prix_prod_date_debut" class="form-control form-control-product">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label-product">{% trans "Date fin (optionnel)" %}</label>
                            <input type="date" id="prix_prod_date_fin" class="form-control form-control-product">
                        </div>
                    </div>

                    <!-- Filtre par produit -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label-product">{% trans "Filtrer par produit" %}</label>
                            <!-- Custom Select pour Filtre Produit -->
                            <div class="custom-select-container" id="customSelectFilter">
                                <div class="custom-select-trigger" onclick="toggleCustomSelect('customSelectFilter')">
                                    <span class="selected-text placeholder">{% trans "Tous les produits" %}</span>
                                    <i class="fas fa-chevron-down arrow"></i>
                                </div>
                                <div class="custom-select-dropdown">
                                    <div class="custom-select-search">
                                        <input type="text" placeholder="{% trans 'Rechercher...' %}" oninput="filterCustomSelectOptions('customSelectFilter', this.value)">
                                    </div>
                                    <div class="custom-select-options">
                                        <!-- Options seront ajoutées via JS -->
                                    </div>
                                </div>
                            </div>
                            <!-- Select caché pour compatibilité avec produit.js -->
                            <div style="position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);">
                                <select id="prix_prod_filter">
                                    <option value="">{% trans "Tous les produits" %}</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Tableau des prix produits -->
                    <div class="table-responsive">
                        <table class="table table-product table-hover">
                            <thead>
                                <tr>
                                    <th>{% trans "Produit" %}</th>
                                    <th>{% trans "Code Prix" %}</th>
                                    <th>{% trans "Type Prix" %}</th>
                                    <th>{% trans "Prix" %}</th>
                                    <th>{% trans "Qté Min" %}</th>
                                    <th>{% trans "Statut" %}</th>
                                    <th>{% trans "Actions" %}</th>
                                </tr>
                            </thead>
                            <tbody id="prix_produits_body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ====== Custom Select Dropdown Functions ======
if (typeof window.allProductsData === 'undefined') {
    window.allProductsData = [];
}

// Toggle dropdown open/close
function toggleCustomSelect(containerId) {
    const container = document.getElementById(containerId);
    const trigger = container.querySelector('.custom-select-trigger');
    const dropdown = container.querySelector('.custom-select-dropdown');

    // Fermer les autres dropdowns
    document.querySelectorAll('.custom-select-container').forEach(c => {
        if (c.id !== containerId) {
            c.querySelector('.custom-select-trigger').classList.remove('open');
            c.querySelector('.custom-select-dropdown').classList.remove('open');
        }
    });

    trigger.classList.toggle('open');
    dropdown.classList.toggle('open');

    if (dropdown.classList.contains('open')) {
        const searchInput = dropdown.querySelector('input');
        if (searchInput) {
            searchInput.value = '';
            searchInput.focus();
            filterCustomSelectOptions(containerId, '');
        }
    }
}

// Filter options based on search
function filterCustomSelectOptions(containerId, searchTerm) {
    const container = document.getElementById(containerId);
    const optionsContainer = container.querySelector('.custom-select-options');
    const options = optionsContainer.querySelectorAll('.custom-select-option');
    const search = searchTerm.toLowerCase();
    let hasResults = false;

    options.forEach(option => {
        const text = option.textContent.toLowerCase();
        if (text.includes(search)) {
            option.style.display = '';
            hasResults = true;
        } else {
            option.style.display = 'none';
        }
    });

    // Show/hide no results message
    let noResults = optionsContainer.querySelector('.custom-select-no-results');
    if (!hasResults) {
        if (!noResults) {
            noResults = document.createElement('div');
            noResults.className = 'custom-select-no-results';
            noResults.textContent = 'Aucun résultat';
            optionsContainer.appendChild(noResults);
        }
        noResults.style.display = '';
    } else if (noResults) {
        noResults.style.display = 'none';
    }
}

// Select an option
function selectCustomOption(containerId, value, text, hiddenSelectId) {
    const container = document.getElementById(containerId);
    const trigger = container.querySelector('.custom-select-trigger');
    const selectedText = trigger.querySelector('.selected-text');
    const dropdown = container.querySelector('.custom-select-dropdown');
    const hiddenSelect = document.getElementById(hiddenSelectId);

    // Update display
    selectedText.textContent = text;
    selectedText.classList.remove('placeholder');

    // Update hidden select
    if (hiddenSelect) {
        // S'assurer que l'option existe dans le select caché
        let option = hiddenSelect.querySelector(`option[value="${value}"]`);
        if (!option && value) {
            option = document.createElement('option');
            option.value = value;
            option.textContent = text;
            hiddenSelect.appendChild(option);
        }
        hiddenSelect.value = value;
        // Trigger change event for jQuery
        hiddenSelect.dispatchEvent(new Event('change', { bubbles: true }));
        // Also trigger for jQuery if available
        if (typeof $ !== 'undefined') {
            $(hiddenSelect).val(value).trigger('change');
        }
        console.log('[CustomSelect] Valeur définie:', hiddenSelectId, '=', value);
    }

    // Update selected state
    container.querySelectorAll('.custom-select-option').forEach(opt => {
        opt.classList.remove('selected');
        if (opt.dataset.value === String(value)) {
            opt.classList.add('selected');
        }
    });

    // Close dropdown
    trigger.classList.remove('open');
    dropdown.classList.remove('open');
}

// Populate custom select with products
function populateCustomSelectProducts(containerId, products, hiddenSelectId, includeAllOption = false) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const optionsContainer = container.querySelector('.custom-select-options');
    optionsContainer.innerHTML = '';

    // Add "All products" option if needed
    if (includeAllOption) {
        const allOption = document.createElement('div');
        allOption.className = 'custom-select-option';
        allOption.dataset.value = '';
        allOption.innerHTML = '<span class="option-ref">{% trans "Tous les produits" %}</span>';
        allOption.onclick = () => selectCustomOption(containerId, '', '{% trans "Tous les produits" %}', hiddenSelectId);
        optionsContainer.appendChild(allOption);
    }

    products.forEach(prod => {
        const option = document.createElement('div');
        option.className = 'custom-select-option';
        option.dataset.value = prod.id;
        option.innerHTML = `<span class="option-ref">${prod.reference}</span><span class="option-name">${prod.nom}</span>`;
        option.onclick = () => selectCustomOption(containerId, prod.id, `${prod.reference} - ${prod.nom}`, hiddenSelectId);
        optionsContainer.appendChild(option);
    });
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.custom-select-container')) {
        document.querySelectorAll('.custom-select-container').forEach(container => {
            container.querySelector('.custom-select-trigger').classList.remove('open');
            container.querySelector('.custom-select-dropdown').classList.remove('open');
        });
    }
});

// Populate generic custom select
function populateCustomSelectGeneric(containerId, items, hiddenSelectId, placeholderText, includeEmpty = true) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const optionsContainer = container.querySelector('.custom-select-options');
    optionsContainer.innerHTML = '';

    // Add empty/default option
    if (includeEmpty) {
        const emptyOption = document.createElement('div');
        emptyOption.className = 'custom-select-option';
        emptyOption.dataset.value = '';
        emptyOption.innerHTML = `<span class="option-ref">${placeholderText}</span>`;
        emptyOption.onclick = () => selectCustomOption(containerId, '', placeholderText, hiddenSelectId);
        optionsContainer.appendChild(emptyOption);
    }

    items.forEach(item => {
        const option = document.createElement('div');
        option.className = 'custom-select-option';
        option.dataset.value = item.id;
        option.innerHTML = `<span class="option-ref">${item.nom || item.name || item.code || ''}</span>`;
        option.onclick = () => selectCustomOption(containerId, item.id, item.nom || item.name || item.code || '', hiddenSelectId);
        optionsContainer.appendChild(option);
    });
}

// Initialize custom selects - load all data from API
function initCustomSelects() {
    // Charger les produits
    fetch('/API/produits/')
        .then(response => response.json())
        .then(data => {
            const products = Array.isArray(data) ? data : (data.results || []);

            const formattedProducts = products.map(prod => ({
                id: prod.id,
                reference: prod.reference || '',
                nom: prod.designation || prod.nom || ''
            }));

            if (formattedProducts.length > 0) {
                window.allProductsData = formattedProducts;
                populateCustomSelectProducts('customSelectProduit', formattedProducts, 'prix_prod_produit', false);
                populateCustomSelectProducts('customSelectFilter', formattedProducts, 'prix_prod_filter', true);
                console.log('[CustomSelect] Chargé', formattedProducts.length, 'produits');
            }
        })
        .catch(err => {
            console.error('[CustomSelect] Erreur chargement produits:', err);
        });

    // Charger les codes prix
    fetch('/API/codes-prix/')
        .then(response => response.json())
        .then(data => {
            const codes = Array.isArray(data) ? data : (data.results || []);
            populateCustomSelectGeneric('customSelectCodePrix', codes, 'prix_prod_code', 'Standard', true);
            console.log('[CustomSelect] Chargé', codes.length, 'codes prix');
        })
        .catch(err => {
            console.error('[CustomSelect] Erreur chargement codes prix:', err);
        });

    // Charger les types prix
    fetch('/API/types-prix/')
        .then(response => response.json())
        .then(data => {
            const types = Array.isArray(data) ? data : (data.results || []);
            populateCustomSelectGeneric('customSelectTypePrix', types, 'prix_prod_type', 'Sélectionner un type', true);
            console.log('[CustomSelect] Chargé', types.length, 'types prix');
        })
        .catch(err => {
            console.error('[CustomSelect] Erreur chargement types prix:', err);
        });
}

// Initialiser au chargement
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCustomSelects);
} else {
    // DOM déjà chargé (cas de chargement dynamique via redirect.js)
    setTimeout(initCustomSelects, 100);
}
</script>
