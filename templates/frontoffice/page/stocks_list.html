{% load i18n %}
{% load static %}

<div class="container-fluid">
    <div class="card bg-white">
        <div class="card-header card-color">
            <p class="h4 text-center text-uppercase font-weight-bold pt-2">
                <i class="fa fa-boxes"></i> {% trans "Liste des Stocks" %}
            </p>
        </div>
        <div class="card-body">
            <!-- Filtres -->
            <div class="card mb-3 bg-white border">
                <div class="card-body">
                    <form method="get" class="form-inline">
                        <div class="form-group mr-3">
                            <label for="entrepot" class="mr-2"><i class="fa fa-warehouse"></i> {% trans "Entrepôt" %}:</label>
                            <select name="entrepot" id="entrepot" class="form-control" onchange="applyFilters()">
                                <option value="">{% trans "Tous les entrepôts" %}</option>
                                {% for e in entrepots %}
                                <option value="{{ e.id }}" {% if selected_entrepot == e.id|stringformat:"s" %}selected{% endif %}>
                                    {{ e.code }} - {{ e.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" name="hide_empty" id="hide_empty" class="form-check-input"
                                   {% if hide_empty %}checked{% endif %} onchange="applyFilters()">
                            <label class="form-check-label" for="hide_empty">
                                {% trans "Masquer les stocks vides" %}
                            </label>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tableau -->
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="thead-dark">
                        <tr>
                            <th>{% trans "Entrepôt" %}</th>
                            <th>{% trans "Référence" %}</th>
                            <th>{% trans "Produit" %}</th>
                            <th class="text-center">{% trans "Quantité" %}</th>
                            <th class="text-center">{% trans "Prix Unit." %}</th>
                            <th class="text-right">{% trans "Valeur" %}</th>
                            <th class="text-center">{% trans "Statut" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stock in stocks %}
                        <tr>
                            <td><strong>{{ stock.warehouse.code }}</strong></td>
                            <td>{{ stock.produit.reference }}</td>
                            <td>{{ stock.produit.designation }}</td>
                            <td class="text-center">
                                <strong>{{ stock.quantity }}</strong>
                            </td>
                            <td class="text-center">{{ stock.produit.prixU|floatformat:2 }} {{ currency.symbol|default:"€" }}</td>
                            <td class="text-right">
                                {{ stock.valeur|floatformat:2 }} {{ currency.symbol|default:"€" }}
                            </td>
                            <td class="text-center">
                                {% if stock.quantity <= 0 %}
                                <span class="badge badge-danger">{% trans "Rupture" %}</span>
                                {% elif stock.quantity <= stock.produit.seuil_critique %}
                                <span class="badge badge-danger">{% trans "Critique" %}</span>
                                {% elif stock.quantity <= stock.produit.seuil_alerte %}
                                <span class="badge badge-warning">{% trans "Alerte" %}</span>
                                {% else %}
                                <span class="badge badge-success">OK</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center text-muted py-4">
                                <i class="fa fa-inbox fa-3x d-block mb-3"></i>
                                {% trans "Aucun stock trouvé" %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {% if stocks.has_other_pages %}
            <nav aria-label="Pagination">
                <ul class="pagination justify-content-center">
                    {% if stocks.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="event.preventDefault(); loadStocksPage({{ stocks.previous_page_number }})">{% trans "Précédent" %}</a>
                    </li>
                    {% endif %}

                    <li class="page-item active">
                        <span class="page-link">
                            Page {{ stocks.number }} sur {{ stocks.paginator.num_pages }}
                        </span>
                    </li>

                    {% if stocks.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="event.preventDefault(); loadStocksPage({{ stocks.next_page_number }})">{% trans "Suivant" %}</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Fonction pour appliquer les filtres (appelée directement par onchange)
function applyFilters() {
    loadStocksPage(1);
}

// Fonction pour gérer la pagination et les filtres
function loadStocksPage(page) {
    const entrepot = document.getElementById('entrepot')?.value || '';
    const hideEmpty = document.getElementById('hide_empty')?.checked || false;

    let url = '/page/stocks_list/?page=' + page;
    if (entrepot) url += '&entrepot=' + entrepot;
    if (hideEmpty) url += '&hide_empty=on';

    // Recharger le contenu via fetch
    fetch(url)
        .then(res => res.text())
        .then(html => {
            const mainContent = document.getElementById('main-content');
            if (mainContent) {
                mainContent.innerHTML = html;
            }
        })
        .catch(err => console.error('Erreur de chargement:', err));
}
</script>
