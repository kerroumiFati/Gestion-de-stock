{% load static %}
{% load i18n %}
<script src="{% static 'script/vente.js' %}" type="text/javascript"></script>

<style>
/* Custom Select Dropdown pour Ventes */
.custom-select-container {
    position: relative;
    width: 100%;
}

.custom-select-trigger {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    background: white;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 38px;
}

.custom-select-trigger:hover {
    border-color: #80bdff;
}

.custom-select-trigger.open {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
}

.custom-select-trigger .selected-text {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    color: #495057;
}

.custom-select-trigger .selected-text.placeholder {
    color: #6c757d;
}

.custom-select-trigger .arrow {
    margin-left: 10px;
    transition: transform 0.2s;
    color: #495057;
}

.custom-select-trigger.open .arrow {
    transform: rotate(180deg);
}

.custom-select-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ced4da;
    border-top: none;
    border-radius: 0 0 4px 4px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1050;
    display: none;
}

.custom-select-dropdown.open {
    display: block;
}

.custom-select-search {
    padding: 8px;
    border-bottom: 1px solid #e9ecef;
}

.custom-select-search input {
    width: 100%;
    padding: 6px 10px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 0.9rem;
}

.custom-select-search input:focus {
    outline: none;
    border-color: #80bdff;
}

.custom-select-options {
    max-height: 250px;
    overflow-y: auto;
}

.custom-select-options::-webkit-scrollbar {
    width: 8px;
}

.custom-select-options::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.custom-select-options::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.custom-select-options::-webkit-scrollbar-thumb:hover {
    background: #a1a1a1;
}

.custom-select-option {
    padding: 8px 12px;
    cursor: pointer;
    transition: background 0.15s;
    border-bottom: 1px solid #f8f9fa;
    color: #000;
}

.custom-select-option:hover {
    background: #f8f9fa;
}

.custom-select-option.selected {
    background: #e9ecef;
    font-weight: 500;
}

.custom-select-no-results {
    padding: 12px;
    text-align: center;
    color: #6c757d;
    font-style: italic;
}
</style>

<!-- Navigation des onglets -->
<div class="container-fluid">
  <ul class="nav nav-tabs" id="venteTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <a class="nav-link active" id="nouvelle-vente-tab" data-toggle="tab" href="#nouvelle-vente" role="tab">
        <i class="fa fa-plus"></i> {% trans "Nouvelle Vente" %}
      </a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link" id="liste-ventes-tab" data-toggle="tab" href="#liste-ventes" role="tab">
        <i class="fa fa-list"></i> {% trans "Liste des Ventes" %}
      </a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link" id="stats-ventes-tab" data-toggle="tab" href="#stats-ventes" role="tab">
        <i class="fa fa-chart-bar"></i> {% trans "Statistiques" %}
      </a>
    </li>
  </ul>

  <div class="tab-content" id="venteTabContent">
    <!-- Onglet Nouvelle Vente -->
    <div class="tab-pane fade show active" id="nouvelle-vente" role="tabpanel">
      <div class="card bg-white mt-3">
        <div class="card-header card-color">
          <p class="h4 text-center text-uppercase font-weight-bold pt-2">
            <i class="fa fa-shopping-cart"></i> {% trans "Nouvelle Vente" %}
          </p>
        </div>
        <div class="card-body container-fluid">
          <!-- Informations de la vente -->
          <div class="row">
            <div class="col-sm-3 mb-2">
              <label>{% trans "Client" %} *</label>
              <!-- Custom Select pour Client -->
              <div class="custom-select-container" id="customSelectVenteClient">
                  <div class="custom-select-trigger" id="venteClientTrigger">
                      <span class="selected-text placeholder">{% trans "Choisir un client..." %}</span>
                      <i class="fas fa-chevron-down arrow"></i>
                  </div>
                  <div class="custom-select-dropdown" id="venteClientDropdown">
                      <div class="custom-select-search">
                          <input type="text" id="venteClientSearch" placeholder="{% trans 'Rechercher...' %}">
                      </div>
                      <div class="custom-select-options" id="venteClientOptions"></div>
                  </div>
                  <div style="position:absolute;width:0;height:0;overflow:hidden;opacity:0;pointer-events:none;">
                      <select id="vente_client"><option value="">{% trans "Choisir un client..." %}</option></select>
                  </div>
              </div>
            </div>
            <div class="col-sm-2 mb-2">
              <label>{% trans "Devise" %}</label>
              <select id="vente_currency" class="form-control">
                <option value=""></option>
              </select>
            </div>
            <div class="col-sm-2 mb-2">
              <label>{% trans "Type de prix" %}</label>
              <select id="vente_type_prix" class="form-control">
                <option value="">{% trans "Chargement..." %}</option>
              </select>
            </div>
            <div class="col-sm-2 mb-2">
              <label>{% trans "Type de paiement" %}</label>
              <select id="vente_paiement" class="form-control">
                <option value="cash">{% trans "Espèces" %}</option>
                <option value="card">{% trans "Carte bancaire" %}</option>
                <option value="check">{% trans "Chèque" %}</option>
                <option value="transfer">{% trans "Virement" %}</option>
                <option value="credit">{% trans "Crédit" %}</option>
              </select>
            </div>
            <div class="col-sm-3 mb-2">
              <label>{% trans "Entrepôt" %} *</label>
              <!-- Custom Select pour Entrepôt -->
              <div class="custom-select-container" id="customSelectVenteWarehouse">
                  <div class="custom-select-trigger" id="venteWarehouseTrigger">
                      <span class="selected-text placeholder">{% trans "Sélectionner un entrepôt" %}...</span>
                      <i class="fas fa-chevron-down arrow"></i>
                  </div>
                  <div class="custom-select-dropdown" id="venteWarehouseDropdown">
                      <div class="custom-select-search">
                          <input type="text" id="venteWarehouseSearch" placeholder="{% trans 'Rechercher...' %}">
                      </div>
                      <div class="custom-select-options" id="venteWarehouseOptions"></div>
                  </div>
                  <div style="position:absolute;width:0;height:0;overflow:hidden;opacity:0;pointer-events:none;">
                      <select id="vente_warehouse"><option value="">{% trans "Sélectionner un entrepôt" %}...</option></select>
                  </div>
              </div>
            </div>
            <div class="col-sm-2 mb-2">
              <label>{% trans "Remise (%)" %}</label>
              <input id="vente_remise" type="number" class="form-control" min="0" max="100" step="0.01" value="0">
            </div>
            <div class="col-sm-3 mb-2">
              <label>{% trans "Numéro" %} ({% trans "optionnel" %})</label>
              <input id="vente_num" type="text" class="form-control" placeholder="{% trans 'Auto-généré' %}">
            </div>
          </div>

          <div class="row">
            <div class="col-sm-12 mb-2">
              <label>{% trans "Observations" %}</label>
              <textarea id="vente_obs" class="form-control" rows="2" placeholder="{% trans 'Commentaires sur la vente...' %}"></textarea>
            </div>
          </div>

          <!-- Recherche de produits -->
          <hr>
          <h5><i class="fa fa-search"></i> {% trans "Ajouter des produits" %}</h5>
          <div class="row">
            <div class="col-sm-3 mb-2">
              <label>{% trans "Référence" %}</label>
              <input id="vente_ref" type="text" class="form-control" placeholder="{% trans 'Filtrer par référence...' %}">
            </div>
            <div class="col-sm-3 mb-2">
              <label>{% trans "Code-barres" %}</label>
              <input id="vente_cb" type="text" class="form-control" placeholder="{% trans 'Scanner ou saisir...' %}">
            </div>
            <div class="col-sm-4 mb-2">
              <label>{% trans "Produit" %}</label>
              <!-- Custom Select pour Produit -->
              <div class="custom-select-container" id="customSelectVenteProd">
                  <div class="custom-select-trigger" id="venteProdTrigger">
                      <span class="selected-text placeholder">{% trans "Choisir un produit..." %}</span>
                      <i class="fas fa-chevron-down arrow"></i>
                  </div>
                  <div class="custom-select-dropdown" id="venteProdDropdown">
                      <div class="custom-select-search">
                          <input type="text" id="venteProdSearch" placeholder="{% trans 'Rechercher...' %}">
                      </div>
                      <div class="custom-select-options" id="venteProdOptions"></div>
                  </div>
                  <div style="position:absolute;width:0;height:0;overflow:hidden;opacity:0;pointer-events:none;">
                      <select id="vente_prod"><option value="">{% trans "Choisir un produit..." %}</option></select>
                  </div>
              </div>
            </div>
            <div class="col-sm-2 mb-2">
              <label>{% trans "Quantité" %}</label>
              <input id="vente_qte" type="number" class="form-control" min="1" value="1">
            </div>
          </div>
          <div class="row">
            <div class="col">
              <button id="vente_add_line" class="btn btn-success">
                <i class="fa fa-plus"></i> {% trans "Ajouter à la vente" %}
              </button>
            </div>
          </div>

          <!-- Tableau des lignes de vente -->
          <div class="row table-responsive m-auto rounded mt-3">
            <table id="tbl_vente" class="table table-hover w-100">
              <thead>
                <tr class="text-uppercase bg-light">
                  <th>{% trans "Référence" %}</th>
                  <th>{% trans "Désignation" %}</th>
                  <th>{% trans "Prix unitaire" %}</th>
                  <th>{% trans "Quantité" %}</th>
                  <th>{% trans "Total ligne" %}</th>
                  <th>{% trans "Actions" %}</th>
                </tr>
              </thead>
              <tbody id="vente_body"></tbody>
              <tfoot>
                <tr class="bg-light font-weight-bold">
                  <td colspan="4" class="text-right">{% trans "Total HT" %}:</td>
                  <td id="vente_total_ht">0.00</td>
                  <td></td>
                </tr>
                <tr class="bg-light font-weight-bold">
                  <td colspan="4" class="text-right">{% trans "Remise" %}:</td>
                  <td id="vente_remise_montant">0.00</td>
                  <td></td>
                </tr>
                <tr class="bg-primary text-white font-weight-bold">
                  <td colspan="4" class="text-right">{% trans "Total TTC" %}:</td>
                  <td id="vente_total_ttc">0.00</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>

          <!-- Actions de la vente -->
          <div class="row mt-3">
            <div class="col">
              <button id="vente_save_draft" class="btn btn-outline-primary">
                <i class="fa fa-save"></i> {% trans "Enregistrer (Brouillon)" %}
              </button>
              <button id="vente_complete" class="btn btn-success ml-2">
                <i class="fa fa-check"></i> {% trans "Finaliser la vente" %}
              </button>
              <button id="vente_clear" class="btn btn-outline-secondary ml-2">
                <i class="fa fa-trash"></i> {% trans "Vider" %}
              </button>
              <span id="vente_status" class="ml-3 font-weight-bold"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Onglet Liste des Ventes -->
    <div class="tab-pane fade" id="liste-ventes" role="tabpanel">
      <div class="card bg-white mt-3">
        <div class="card-header card-color">
          <p class="h4 text-center text-uppercase font-weight-bold pt-2">
            <i class="fa fa-list"></i> {% trans "Liste des Ventes" %}
          </p>
        </div>
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-sm-4">
              <label for="ventes_filter" class="mr-2">{% trans "Filtrer par statut" %}</label>
              <select id="ventes_filter" class="form-control form-control-sm">
                <option value="all">{% trans "Toutes" %}</option>
                <option value="draft">{% trans "Brouillons" %}</option>
                <option value="completed">{% trans "Finalisées" %}</option>
              </select>
            </div>
          </div>
          <div class="table-responsive">
            <table id="tbl_liste_ventes" class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>{% trans "Numéro" %}</th>
                  <th>{% trans "Date" %}</th>
                  <th>{% trans "Client" %}</th>
                  <th>{% trans "Statut" %}</th>
                  <th>{% trans "Paiement" %}</th>
                  <th>{% trans "Total TTC" %}</th>
                  <th>{% trans "Actions" %}</th>
                </tr>
              </thead>
              <tbody id="liste_ventes_body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Détails de la Vente -->
    <div class="modal fade" id="saleDetailsModal" tabindex="-1" role="dialog" aria-labelledby="saleDetailsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="saleDetailsModalLabel">
              <i class="fa fa-file-invoice"></i> {% trans "Détails de la vente" %}
            </h5>
            <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="saleDetailsContent">
            <div class="text-center py-5">
              <i class="fa fa-spinner fa-spin fa-3x text-muted"></i>
              <p class="mt-3 text-muted">{% trans "Chargement des détails..." %}</p>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">
              <i class="fa fa-times"></i> {% trans "Fermer" %}
            </button>
            <button type="button" class="btn btn-primary" id="printSaleDetails">
              <i class="fa fa-print"></i> {% trans "Imprimer" %}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Onglet Statistiques -->
    <div class="tab-pane fade" id="stats-ventes" role="tabpanel">
      <div class="card bg-white mt-3">
        <div class="card-header card-color">
          <p class="h4 text-center text-uppercase font-weight-bold pt-2">
            <i class="fa fa-chart-bar"></i> {% trans "Statistiques des Ventes" %}
          </p>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              <div class="card bg-primary text-white">
                <div class="card-body text-center">
                  <h4 id="stat_ventes_today">0</h4>
                  <p>{% trans "Ventes aujourd'hui" %}</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-success text-white">
                <div class="card-body text-center">
                  <h4 id="stat_ventes_week">0</h4>
                  <p>{% trans "Ventes cette semaine" %}</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-info text-white">
                <div class="card-body text-center">
                  <h4 id="stat_ventes_month">0</h4>
                  <p>{% trans "Ventes ce mois" %}</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-warning text-white">
                <div class="card-body text-center">
                  <h4 id="stat_ventes_total">0</h4>
                  <p>{% trans "Total des ventes" %}</p>
                </div>
              </div>
            </div>
          </div>

          <div class="row mt-4">
            <div class="col-md-3">
              <div class="card bg-dark text-white">
                <div class="card-body text-center">
                  <h4 id="stat_ca_today">0.00</h4>
                  <p>{% trans "CA" %} {% trans "aujourd'hui" %}</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-secondary text-white">
                <div class="card-body text-center">
                  <h4 id="stat_ca_week">0.00</h4>
                  <p>{% trans "CA" %} {% trans "cette semaine" %}</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-danger text-white">
                <div class="card-body text-center">
                  <h4 id="stat_ca_month">0.00</h4>
                  <p>{% trans "CA" %} {% trans "ce mois" %}</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card" style="background: linear-gradient(45deg, #6a11cb 0%, #2575fc 100%);">
                <div class="card-body text-center text-white">
                  <h4 id="stat_ca_total">0.00</h4>
                  <p>{% trans "CA" %} {% trans "total" %}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
(function() {
    var venteCustomSelectData = {
        clients: [],
        warehouses: [],
        products: []
    };

    function toggleVenteCustomSelect(containerId) {
        var container = document.getElementById(containerId);
        if (!container) return;

        var trigger = container.querySelector('.custom-select-trigger');
        var dropdown = container.querySelector('.custom-select-dropdown');
        var isOpen = dropdown.classList.contains('open');

        // Fermer tous les autres dropdowns
        document.querySelectorAll('.custom-select-dropdown.open').forEach(function(d) {
            d.classList.remove('open');
            var t = d.closest('.custom-select-container');
            if (t) t.querySelector('.custom-select-trigger').classList.remove('open');
        });

        if (!isOpen) {
            dropdown.classList.add('open');
            trigger.classList.add('open');
            var searchInput = dropdown.querySelector('input');
            if (searchInput) {
                searchInput.value = '';
                searchInput.focus();
            }
            filterVenteOptions(containerId, '');
        }
    }

    function filterVenteOptions(containerId, searchText) {
        var container = document.getElementById(containerId);
        if (!container) return;

        var optionsContainer = container.querySelector('.custom-select-options');
        var options = optionsContainer.querySelectorAll('.custom-select-option');
        var search = (searchText || '').toLowerCase().trim();
        var hasVisible = false;

        for (var i = 0; i < options.length; i++) {
            var opt = options[i];
            var text = (opt.textContent || '').toLowerCase();
            var match = !search || text.indexOf(search) !== -1;
            opt.style.display = match ? '' : 'none';
            if (match) hasVisible = true;
        }

        var noResults = optionsContainer.querySelector('.custom-select-no-results');
        if (!hasVisible) {
            if (!noResults) {
                noResults = document.createElement('div');
                noResults.className = 'custom-select-no-results';
                noResults.textContent = 'Aucun résultat trouvé';
                optionsContainer.appendChild(noResults);
            }
            noResults.style.display = '';
        } else if (noResults) {
            noResults.style.display = 'none';
        }
    }

    function selectVenteOption(containerId, value, text, hiddenSelectId) {
        var container = document.getElementById(containerId);
        if (!container) return;

        var trigger = container.querySelector('.custom-select-trigger');
        var selectedText = trigger.querySelector('.selected-text');
        var dropdown = container.querySelector('.custom-select-dropdown');
        var hiddenSelect = document.getElementById(hiddenSelectId);

        selectedText.textContent = text;
        selectedText.classList.toggle('placeholder', !value);

        dropdown.classList.remove('open');
        trigger.classList.remove('open');

        if (hiddenSelect) {
            var option = hiddenSelect.querySelector('option[value="' + value + '"]');
            if (!option && value) {
                option = document.createElement('option');
                option.value = value;
                option.textContent = text;
                hiddenSelect.appendChild(option);
            }
            hiddenSelect.value = value;

            if (typeof jQuery !== 'undefined') {
                jQuery(hiddenSelect).val(value).trigger('change');
            }
        }

        var allOpts = container.querySelectorAll('.custom-select-option');
        for (var i = 0; i < allOpts.length; i++) {
            if (allOpts[i].getAttribute('data-value') === String(value)) {
                allOpts[i].classList.add('selected');
            } else {
                allOpts[i].classList.remove('selected');
            }
        }
    }

    function populateVenteClients() {
        var optionsContainer = document.getElementById('venteClientOptions');
        if (!optionsContainer) return;

        optionsContainer.innerHTML = '';

        var defaultOpt = document.createElement('div');
        defaultOpt.className = 'custom-select-option';
        defaultOpt.setAttribute('data-value', '');
        defaultOpt.textContent = 'Choisir un client...';
        defaultOpt.onclick = function() {
            selectVenteOption('customSelectVenteClient', '', 'Choisir un client...', 'vente_client');
        };
        optionsContainer.appendChild(defaultOpt);

        venteCustomSelectData.clients.forEach(function(c) {
            var opt = document.createElement('div');
            opt.className = 'custom-select-option';
            opt.setAttribute('data-value', c.id);
            var label = [(c.nom || '').trim(), (c.prenom || '').trim()].filter(Boolean).join(' ') || ('Client #' + c.id);
            opt.textContent = label;
            opt.onclick = function() {
                selectVenteOption('customSelectVenteClient', c.id, label, 'vente_client');
            };
            optionsContainer.appendChild(opt);
        });
    }

    function populateVenteWarehouses() {
        var optionsContainer = document.getElementById('venteWarehouseOptions');
        if (!optionsContainer) return;

        optionsContainer.innerHTML = '';

        var defaultOpt = document.createElement('div');
        defaultOpt.className = 'custom-select-option';
        defaultOpt.setAttribute('data-value', '');
        defaultOpt.textContent = 'Sélectionner un entrepôt...';
        defaultOpt.onclick = function() {
            selectVenteOption('customSelectVenteWarehouse', '', 'Sélectionner un entrepôt...', 'vente_warehouse');
        };
        optionsContainer.appendChild(defaultOpt);

        venteCustomSelectData.warehouses.forEach(function(w) {
            var opt = document.createElement('div');
            opt.className = 'custom-select-option';
            opt.setAttribute('data-value', w.id);
            var label = (w.code || '') + ' - ' + (w.name || '');
            opt.textContent = label;
            opt.onclick = function() {
                selectVenteOption('customSelectVenteWarehouse', w.id, label, 'vente_warehouse');
            };
            optionsContainer.appendChild(opt);
        });
    }

    function populateVenteProducts() {
        var optionsContainer = document.getElementById('venteProdOptions');
        if (!optionsContainer) return;

        optionsContainer.innerHTML = '';

        var defaultOpt = document.createElement('div');
        defaultOpt.className = 'custom-select-option';
        defaultOpt.setAttribute('data-value', '');
        defaultOpt.textContent = 'Choisir un produit...';
        defaultOpt.onclick = function() {
            selectVenteOption('customSelectVenteProd', '', 'Choisir un produit...', 'vente_prod');
        };
        optionsContainer.appendChild(defaultOpt);

        venteCustomSelectData.products.forEach(function(p) {
            var opt = document.createElement('div');
            opt.className = 'custom-select-option';
            opt.setAttribute('data-value', p.id);
            var label = (p.reference ? (p.reference + ' - ') : '') + (p.designation || 'Produit #' + p.id);
            opt.textContent = label;
            opt.onclick = function() {
                selectVenteOption('customSelectVenteProd', p.id, label, 'vente_prod');
            };
            optionsContainer.appendChild(opt);
        });
    }

    function loadVenteClients() {
        console.log('[Vente Custom] Loading clients...');
        fetch('/API/clients/?page_size=1000')
            .then(function(response) { return response.json(); })
            .then(function(data) {
                var list = Array.isArray(data) ? data : (data && data.results ? data.results : []);
                console.log('[Vente Custom] Clients loaded:', list.length);
                venteCustomSelectData.clients = list;
                populateVenteClients();

                // Preselect Divers if present
                var diversId = null;
                list.forEach(function(c) {
                    var label = [(c.nom || ''), (c.prenom || '')].join(' ').toLowerCase();
                    if (!diversId && (label === 'divers' || label.includes('divers'))) {
                        diversId = c.id;
                    }
                });
                if (diversId) {
                    var diversClient = list.find(function(c) { return c.id === diversId; });
                    if (diversClient) {
                        var label = [(diversClient.nom || '').trim(), (diversClient.prenom || '').trim()].filter(Boolean).join(' ');
                        selectVenteOption('customSelectVenteClient', diversId, label, 'vente_client');
                    }
                }
            })
            .catch(function(err) {
                console.error('[Vente Custom] Error loading clients:', err);
            });
    }

    function loadVenteWarehouses() {
        console.log('[Vente Custom] Loading warehouses...');
        fetch('/API/entrepots/?page_size=1000')
            .then(function(response) { return response.json(); })
            .then(function(data) {
                var list = Array.isArray(data) ? data : (data && data.results ? data.results : []);
                list = list.filter(function(w) { return w && w.is_active !== false; });
                console.log('[Vente Custom] Warehouses loaded:', list.length);
                venteCustomSelectData.warehouses = list;
                populateVenteWarehouses();

                // Try to preselect default warehouse
                fetch('/API/system-config/')
                    .then(function(r) { return r.json(); })
                    .then(function(cfg) {
                        var dw = cfg && (cfg[0] || cfg).default_warehouse;
                        if (dw) {
                            var defWh = list.find(function(w) { return String(w.id) === String(dw); });
                            if (defWh) {
                                var label = (defWh.code || '') + ' - ' + (defWh.name || '');
                                selectVenteOption('customSelectVenteWarehouse', defWh.id, label, 'vente_warehouse');
                            }
                        }
                    })
                    .catch(function() {});
            })
            .catch(function(err) {
                console.error('[Vente Custom] Error loading warehouses:', err);
            });
    }

    function loadVenteProducts() {
        console.log('[Vente Custom] Loading products...');
        fetch('/API/produits/?page_size=1000')
            .then(function(response) { return response.json(); })
            .then(function(data) {
                var list = Array.isArray(data) ? data : (data && data.results ? data.results : []);
                console.log('[Vente Custom] Products loaded:', list.length);
                venteCustomSelectData.products = list;
                populateVenteProducts();
            })
            .catch(function(err) {
                console.error('[Vente Custom] Error loading products:', err);
            });
    }

    function initVenteCustomSelects() {
        console.log('[Vente Custom] Initializing custom selects...');

        // Event listeners pour les triggers
        var clientTrigger = document.getElementById('venteClientTrigger');
        if (clientTrigger) {
            clientTrigger.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleVenteCustomSelect('customSelectVenteClient');
            });
        }

        var warehouseTrigger = document.getElementById('venteWarehouseTrigger');
        if (warehouseTrigger) {
            warehouseTrigger.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleVenteCustomSelect('customSelectVenteWarehouse');
            });
        }

        var prodTrigger = document.getElementById('venteProdTrigger');
        if (prodTrigger) {
            prodTrigger.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleVenteCustomSelect('customSelectVenteProd');
            });
        }

        // Event listeners pour la recherche
        var clientSearch = document.getElementById('venteClientSearch');
        if (clientSearch) {
            clientSearch.addEventListener('input', function() {
                filterVenteOptions('customSelectVenteClient', this.value);
            });
            clientSearch.addEventListener('click', function(e) { e.stopPropagation(); });
        }

        var warehouseSearch = document.getElementById('venteWarehouseSearch');
        if (warehouseSearch) {
            warehouseSearch.addEventListener('input', function() {
                filterVenteOptions('customSelectVenteWarehouse', this.value);
            });
            warehouseSearch.addEventListener('click', function(e) { e.stopPropagation(); });
        }

        var prodSearch = document.getElementById('venteProdSearch');
        if (prodSearch) {
            prodSearch.addEventListener('input', function() {
                filterVenteOptions('customSelectVenteProd', this.value);
            });
            prodSearch.addEventListener('click', function(e) { e.stopPropagation(); });
        }

        // Fermer quand on clique ailleurs
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.custom-select-container')) {
                document.querySelectorAll('.custom-select-dropdown.open').forEach(function(d) {
                    d.classList.remove('open');
                    var t = d.closest('.custom-select-container');
                    if (t) t.querySelector('.custom-select-trigger').classList.remove('open');
                });
            }
        });

        // Charger les données
        loadVenteClients();
        loadVenteWarehouses();
        loadVenteProducts();
    }

    // Initialiser au chargement
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initVenteCustomSelects);
    } else {
        initVenteCustomSelects();
    }

    // Pour le chargement dynamique
    document.addEventListener('fragment:loaded', function(e) {
        if (e && e.detail && e.detail.name === 'vente') {
            initVenteCustomSelects();
        }
    });

    // Fallback
    setTimeout(function() {
        var optionsContainer = document.getElementById('venteClientOptions');
        if (optionsContainer && optionsContainer.children.length === 0) {
            console.log('[Vente Custom] Fallback initialization...');
            initVenteCustomSelects();
        }
    }, 500);
})();
</script>
