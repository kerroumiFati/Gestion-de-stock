<!DOCTYPE html>
<html lang="FR">

<head>
    <meta charset="UTF-8">
    <title>Market</title>
    {% load static %}

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <!-- Material Design Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/material-design-iconic-font/2.2.0/css/material-design-iconic-font.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap4.min.css" rel="stylesheet">
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap4-theme@1.5.2/dist/select2-bootstrap4.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'style/select2-custom.css' %}">

    <link rel="stylesheet" href="{% static 'style/style.css' %}">
    <link rel="stylesheet" href="{% static 'style/theme.css' %}">
    <link rel="stylesheet" href="{% static 'style/sidebar-improvements.css' %}">
    <!-- Hamburger Menu CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/hamburgers/1.1.3/hamburgers.min.css" rel="stylesheet">

    <link rel="stylesheet" href="{% static 'style/main.css' %}">
    <link rel="stylesheet" href="{% static 'style/tables.css' %}">
    <!-- Responsive CSS -->
    <link rel="stylesheet" href="{% static 'style/responsive.css' %}">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <link rel="icon" href="{% static 'img/no-photo.png' %}" type="image/png">

    <!-- Critical Responsive Styles (inline fallback) -->
    <style>
        /* Mobile First - Critical Styles */
        @media (max-width: 767px) {
            /* Sidebar mobile */
            .sidebar-wrapper {
                position: fixed !important;
                left: -260px !important;
                top: 0 !important;
                bottom: 0 !important;
                width: 260px !important;
                z-index: 1050 !important;
                transition: left 0.3s ease !important;
            }

            .page-wrapper.toggled .sidebar-wrapper {
                left: 0 !important;
            }

            .page-content {
                margin-left: 0 !important;
                width: 100% !important;
                padding: 10px !important;
            }

            #show-sidebar {
                display: block !important;
                position: fixed !important;
                top: 10px !important;
                left: 10px !important;
                z-index: 1040 !important;
            }

            /* Overlay */
            .page-wrapper.toggled::before {
                content: '' !important;
                position: fixed !important;
                inset: 0 !important;
                background: rgba(0,0,0,0.5) !important;
                z-index: 1049 !important;
            }

            /* Tables */
            .table-responsive {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }

            table {
                font-size: 0.85rem !important;
                min-width: 100% !important;
            }

            table th, table td {
                padding: 0.5rem !important;
                white-space: nowrap !important;
            }

            /* Cards empilées */
            .row > [class*="col-"] {
                flex: 0 0 100% !important;
                max-width: 100% !important;
                margin-bottom: 15px !important;
            }

            /* Formulaires */
            .modal-dialog {
                margin: 0.5rem !important;
                max-width: calc(100% - 1rem) !important;
            }

            .form-control, .btn {
                font-size: 0.9rem !important;
            }

            /* Boutons */
            .btn-group {
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 5px !important;
            }

            /* Sidebar menu */
            .sidebar-menu ul li a {
                padding: 10px 15px !important;
                font-size: 0.95rem !important;
            }

            /* Container */
            .container-fluid {
                padding-left: 10px !important;
                padding-right: 10px !important;
            }

            /* DataTables */
            .dataTables_wrapper {
                overflow-x: auto !important;
            }

            .dataTables_length, .dataTables_filter {
                margin-bottom: 10px !important;
            }

            /* Cards */
            .card {
                margin-bottom: 15px !important;
            }

            .card-body {
                padding: 15px !important;
            }
        }

        /* Tablet */
        @media (min-width: 768px) and (max-width: 1023px) {
            .row > .col-md-3, .row > .col-lg-3 {
                flex: 0 0 50% !important;
                max-width: 50% !important;
            }
        }

        /* Desktop - Position toggle button after sidebar */
        @media (min-width: 768px) {
            .sidebar-wrapper {
                /* Sidebar visible by default on desktop */
            }

            /* Position toggle button just after sidebar with spacing */
            #show-sidebar {
                display: block !important;
                position: fixed !important;
                top: 15px !important;
                left: 275px !important; /* 260px sidebar + 15px spacing */
                z-index: 1060 !important;
                transition: left 0.3s ease !important;
            }

            /* When sidebar is hidden, move button to the left edge */
            .page-wrapper:not(.toggled) #show-sidebar {
                left: 15px !important;
            }
        }
    </style>
</head>
<body>
<div class="page-wrapper chiller-theme toggled">
    <a id="show-sidebar" class="btn btn-sm btn-dark" href="#"> <i
            class="fas fa-bars"></i>
    </a>
    <nav id="sidebar" class="sidebar-wrapper">
        <div class="sidebar-content">
            <div class="sidebar-brand">
                <a href="./" class="h2 pt-2">Market</a>
                <div id="close-sidebar">
                    <i class="fas fa-times"></i>
                </div>
            </div>
            <div class="sidebar-header">
                <div class="user-pic">
                    <img class="img-responsive img-rounded" src="{% static 'img/no-photo.png' %}"
                         alt="User picture">
                </div>
                <div class="user-info">
						<span class="user-name"> <strong>Admin </strong>
						</span> <span class="user-role">Admin</span> 
                </div>
                <div class="user-actions ml-auto">
                  <div class="dropdown">
                    <button class="btn btn-outline-secondary position-relative" type="button" id="alertsDropdownClassic" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-bell"></i>
                        <span class="badge badge-danger" id="notification-count-classic" style="position:absolute; top:-6px; right:-6px; display:none;">0</span>
                    </button>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="alertsDropdownClassic">
                        <h6 class="dropdown-header">Notifications</h6>
                        <div id="alerts-items-classic"></div>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item text-center" href="#" onclick="show('statistiques');return false;">Voir toutes</a>
                    </div>
                  </div>
                </div>
           </div>
           <!-- notifications area moved next to user info -->
           <!-- sidebar-header  -->

            <!-- sidebar-search  -->
            <div class="sidebar-menu">
                <ul>
                    <li class="header-menu"><span>Gestion de Stock</span></li>
                    <li><a href="#" onclick="show('produit')" class="sidebar-item">
                        <i class="fas fa-box"></i><span>Produits</span>
                    </a></li>
                    <li><a href="#" onclick="show('client')" class="sidebar-item">
                        <i class="fas fa-users"></i><span>Clients</span>
                    </a></li>
                    <li><a href="#" onclick="show('fournisseur')" class="sidebar-item">
                        <i class="fas fa-truck"></i><span>Fournisseurs</span>
                    </a></li>
                    <li><a href="#" onclick="show('achat')" class="sidebar-item">
                        <i class="fas fa-shopping-bag"></i><span>Achats</span>
                    </a></li>
                    <li><a href="#" onclick="show('vente')" class="sidebar-item">
                        <i class="fas fa-shopping-cart"></i><span>Ventes</span>
                    </a></li>
                    <li><a href="/caisse/" class="sidebar-item">
                        <i class="fas fa-cash-register"></i><span>Caisse</span>
                    </a></li>
                    <li><a href="#" onclick="show('categorie')" class="sidebar-item">
                        <i class="fas fa-tags"></i><span>Catégories</span>
                    </a></li>
                    
                    <li class="header-menu"><span>Reporting & Gestion</span></li>
                    <li><a href="#" onclick="show('statistiques')" class="sidebar-item">
                        <i class="fas fa-chart-bar"></i><span>Statistiques</span>
                    </a></li>
                    <li><a href="#" onclick="show('rapports')" class="sidebar-item">
                        <i class="fas fa-file-export"></i><span>Rapports</span>
                    </a></li>
                    <li><a href="#" onclick="show('facture')" class="sidebar-item">
                        <i class="fas fa-file-invoice"></i><span>Factures</span>
                    </a></li>
                    <li><a href="#" onclick="show('inventaire')" class="sidebar-item">
                        <i class="fas fa-clipboard-check"></i><span>Inventaires</span>
                    </a></li>
                    <li><a href="#" onclick="show('mouvements')" class="sidebar-item">
                        <i class="fas fa-exchange-alt"></i><span>Mouvements</span>
                    </a></li>
                    <li><a href="#" onclick="show('entrepots')" class="sidebar-item">
                        <i class="fas fa-warehouse"></i><span>Entrepôts</span>
                    </a></li>
                    <li><a href="#" onclick="show('parametres')" class="sidebar-item">
                        <i class="fas fa-cogs"></i><span>Paramètres</span>
                    </a></li>
                    {% if user.is_staff %}
                    <li class="header-menu"><span>Administration</span></li>
                    <li><a href="#" onclick="show('admin')" class="sidebar-item">
                        <i class="fas fa-tools"></i><span>Tableau de bord Admin</span>
                    </a></li>
                    <li><a href="/users-admin/" class="sidebar-item">
                        <i class="fas fa-user-shield"></i><span>Administration des utilisateurs</span>
                    </a></li>
                    <li><a href="/audit-logs/" class="sidebar-item">
                        <i class="fas fa-clipboard-list"></i><span>Journaux d'audit</span>
                    </a></li>
                    {% endif %}
                </ul>
            </div>

            <!-- sidebar-menu  -->
        </div>
        <!-- sidebar-content  -->
        <div class="sidebar-footer">
            <a href="/logout/" class="logout-link"> <i class="fa fa-power-off"></i> <span>Déconnexion</span>
            </a>
        </div>
    </nav>
    <!-- sidebar-wrapper  -->
    <main class="page-content">
        <div class="container-fluid" id="main-content">

        </div>
    </main>
    <!-- page-content" -->
</div>
<!-- page-wrapper -->
<script src="{% static 'script/redirect.js' %}"></script>
<script src="{% static 'js/main.js' %}"></script>
<script src="{% static 'js/sidebar-enhancements.js' %}"></script>
<!-- Initialisation globale de Select2 -->
<script src="{% static 'script/select2-init.js' %}"></script>
<script>
(async function loadAlertsClassic(){
 try{
   const res = await fetch('/API/alerts/');
   if(!res.ok) throw new Error('HTTP '+res.status);
   const data = await res.json();
   const count = data.counts && data.counts.total || 0;
   const badge = document.getElementById('notification-count-classic');
   if(badge){
     badge.textContent = count;
     badge.style.display = count>0 ? 'inline-block' : 'none';
   }
   const container = document.getElementById('alerts-items-classic');
   if(container){
     container.innerHTML = '';
     const items = data.items || [];
     if(items.length===0){
       container.innerHTML = '<span class="dropdown-item text-muted">Aucune alerte</span>';
     } else {
       items.forEach(it=>{
         const icon = it.level==='rupture' ? 'fas fa-times-circle text-danger' : (it.level==='critique' ? 'fas fa-exclamation-triangle text-warning' : 'fas fa-info-circle text-info');
         const a = document.createElement('a');
         a.className = 'dropdown-item';
         a.href = '#';
         a.onclick = function(){ show('produit'); return false; };
         a.innerHTML = `<i class="${icon} mr-2"></i>${it.reference || ''} - ${it.designation || ''} (${it.quantite})`;
         container.appendChild(a);
       });
     }
   }
 }catch(e){
   console.warn('loadAlertsClassic failed', e);
 }
})();
</script>
</body>
</html>
